{% template main %}
{% assign user_id = trmnl.plugin_settings.custom_fields_values.user_id | default: 0 | plus: 0 %}
{% if user_id == 0 %}

  <!-- No User ID Provided -->
  <div class="layout layout--col gap--medium p--4 text--center">
    <span class="value value--large">ğŸ‘¤ No User ID</span>
    <span class="label label--medium">Please enter a Twitch User ID in the plugin settings</span>
    <div class="outline rounded--medium p--4 mt--4">
      <span class="value value--small">Example IDs:</span>
      <div class="flex flex--col gap--small mt--2">
        <span class="label">â€¢ 141981764 (TwitchDev)</span>
        <span class="label">â€¢ 26610234 (CohhCarnage)</span>
        <span class="label">â€¢ 411377640 (Jynxzi)</span>
      </div>
    </div>
  </div>

{% else %}

  <!-- User ID Provided - Show Stats -->
  <div class="layout layout--col gap--space-between">
    
    <!-- Header with User Avatar and Info -->
    <div class="grid grid--cols-3 gap--small">
      <div class="col--span-1">
        {% if data.user.profile_image_url %}
          <img src="{{ data.user.profile_image_url }}" class="image rounded w--16 h--16" alt="{{ data.user.display_name }}">
        {% else %}
          <div class="avatar-placeholder rounded--medium bg--gray-20 flex flex--center">
            <span class="value value--large">{{ data.user.display_name | slice: 0 }}</span>
          </div>
        {% endif %}
      </div>
      <div class="col--span-2">
        <div class="item">
          <div class="meta"></div>
          <div class="content">
            <span class="title title--large" data-pixel-perfect="true">{{ data.user.display_name | default: "User" }}</span>
            <span class="label">{{ data.user.description | default: "No description" | truncate: 50 }}</span>
            <div class="flex flex--row gap--small mt--2">
              <span class="label label--small label--outline">ID: {{ user_id }}</span>
              <span class="label label--small label--outline">Joined {{ data.user.created_at | date: "%Y" }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Latest Stream or Current Stream -->
    {% if data.stream and data.stream.type == "live" %}
      <!-- Current Live Stream -->
      <div class="grid grid--cols-2 bg--white rounded--medium p--2 h--54">
        <div class="item">
          <div class="meta">
            <span class="index">ğŸ”´</span>
          </div>
          <div class="content">
            <span class="value value--large value--tnums" data-value-fit="true">{{ data.stream.viewer_count | default: "0" }}</span>
            <span class="label">Current Viewers</span>
          </div>
        </div>
        <div class="item">
          <div class="meta"></div>
          <div class="content">
            <span class="value value--small" data-clamp="1">{{ data.stream.game_name | default: "Unknown" }}</span>
            <span class="label">Game</span>
          </div>
        </div>
      </div>
      <div class="item">
        <div class="meta"></div>
        <div class="content">
          <span class="title title--small" data-clamp="2">{{ data.stream.title | default: "No stream title" }}</span>
          <span class="label">Stream Title</span>
        </div>
      </div>
      
      <!-- Stream Thumbnail - FIXED SYNTAX -->
      {% if data.stream.thumbnail_url %}
        {% assign thumbnail_url = data.stream.thumbnail_url | replace: '{width}', '800' | replace: '{height}', '450' %}
        <div class="w--full mt--2">
          <img src="{{ thumbnail_url }}" class="image image-dither stream-thumbnail rounded w--96" alt="Stream thumbnail">
        </div>
      {% endif %}
      
    {% else %}
      <!-- Offline - Show Latest VOD if available -->
      <div class="item bg--white outline rounded--medium p--2 mb--2">
        <div class="meta">
          <span class="index">âš«</span>
        </div>
        <div class="content">
          <span class="value value--large">Offline</span>
          <span class="label">Stream Status</span>
        </div>
      </div>
      
      <!-- Try to get latest video from data.videos -->
      {% if data.videos and data.videos.size > 0 %}
        {% assign latest = data.videos[0] %}
        <div class="flex flex--col gap--small">
          <span class="title title--small">ğŸ“¼ Latest VOD</span>
          <div class="item outline rounded--medium p--2">
            <div class="meta">
              <span class="index">ğŸ¬</span>
            </div>
            <div class="content">
              <span class="title title--small" data-clamp="1">{{ latest.title }}</span>
              <div class="flex flex--row gap--small mt--1">
                <span class="label label--small">{{ latest.duration }}</span>
                <span class="label label--small">{{ latest.view_count }} views</span>
              </div>
              <!-- VOD Thumbnail - FIXED SYNTAX -->
              {% if latest.thumbnail_url %}
                {% assign vod_thumb = latest.thumbnail_url | replace: '%{width}', '640' | replace: '%{height}', '360' %}
                <div class="mt--2">
                  <img src="{{ vod_thumb }}" class="vod-thumbnail rounded--small w--full" alt="VOD thumbnail">
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      {% endif %}
    {% endif %}

    <!-- Key Metrics Row -->
    <div class="grid grid--cols-3 gap--small">
      <div class="item">
        <div class="meta"></div>
        <div class="content text--center">
          <span class="value value--tnums" data-value-fit="true">{{ data.followers.total | default: "0" }}</span>
          <span class="label">Followers</span>
        </div>
      </div>
      <div class="item">
        <div class="meta"></div>
        <div class="content text--center">
          <span class="value value--tnums" data-value-fit="true">{{ data.subscribers.total | default: "0" }}</span>
          <span class="label">Subscribers</span>
        </div>
      </div>
      <div class="item">
        <div class="meta"></div>
        <div class="content text--center">
          <span class="value value--tnums" data-value-fit="true">{{ data.chatters.total | default: "0" }}</span>
          <span class="label">Chatters</span>
        </div>
      </div>
    </div>

    <!-- Goals Section - Only if exists -->
    {% if data.goals and data.goals.size > 0 %}
    <div class="flex flex--col gap--small">
      <span class="title title--small">ğŸ¯ Current Goals</span>
      {% for goal in data.goals %}
      <div class="progress-bar progress-bar--small">
        <div class="content">
          <span class="label label--small">{{ goal.title }}</span>
          {% assign percent = goal.current_amount | times: 100 | divided_by: goal.target_amount %}
          <span class="value value--xxsmall">{{ percent }}%</span>
        </div>
        <div class="track">
          <div class="fill" style="width: {{ percent }}%"></div>
        </div>
        <span class="label label--small label--gray">{{ goal.current_amount }} / {{ goal.target_amount }}</span>
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <!-- Hype Train - Only if exists -->
    {% if data.hypetrain %}
    <div class="item bg--white outline rounded--medium p--2">
      <div class="meta">
        <span class="index">ğŸš‚</span>
      </div>
      <div class="content">
        <span class="value value--small">Hype Train Level {{ data.hypetrain.level }}</span>
        <div class="progress-bar progress-bar--small">
          <div class="track">
            {% assign hype_progress = data.hypetrain.progress | times: 100 | divided_by: data.hypetrain.goal %}
            <div class="fill" style="width: {{ hype_progress }}%; background: #000000;"></div>
          </div>
        </div>
        <span class="label label--small">{{ data.hypetrain.progress }} / {{ data.hypetrain.goal }} points</span>
      </div>
    </div>
    {% endif %}

    <!-- Bits Leaderboard - Only if exists -->
    {% if data.bits and data.bits.size > 0 %}
    <div class="flex flex--col gap--small">
      <span class="title title--small">â­ Top Cheerers</span>
      <div class="grid grid--cols-2 gap--small">
        {% for cheerer in data.bits limit:4 %}
        <div class="item">
          <div class="meta">
            <span class="index">{{ forloop.index }}</span>
          </div>
          <div class="content">
            <span class="label label--small" data-clamp="1">{{ cheerer.user_name }}</span>
            <span class="value value--xxsmall">{{ cheerer.score }} bits</span>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Recent Followers - Only if exists -->
    {% if data.followers and data.followers.recent.size > 0 %}
    <div class="flex flex--col gap--small">
      <span class="title title--small">ğŸ”„ Recent Followers</span>
      <div class="flex flex--row gap--small flex--wrap">
        {% for follower in data.followers.recent limit:5 %}
        <span class="label label--small label--outline">{{ follower.user_name }}</span>
        {% endfor %}
      </div>
    </div>
    {% endif %}

  </div>

  <!-- Title Bar -->
  <div class="title_bar">
    <svg class="w--8 h--8" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill="none">
      <path fill="#ffffff" d="M13 7.5l-2 2H9l-1.75 1.75V9.5H5V2h8v5.5z"/>
      <g fill="#9146FF">
        <path d="M4.5 1L2 3.5v9h3V15l2.5-2.5h2L14 8V1H4.5zM13 7.5l-2 2H9l-1.75 1.75V9.5H5V2h8v5.5z"/>
        <path d="M11.5 3.75h-1v3h1v-3zM8.75 3.75h-1v3h1v-3z"/>
      </g>
    </svg>
    <span class="title">Twitch Dashboard</span>
    <span class="instance">{{ data.user.display_name }}</span>
  </div>
  
{% endif %}

<style>
  .outline { 
    border: 1px solid #000000;
    border-radius: 10px;
  }
  .rounded--medium { border-radius: 10px; }
  .rounded--small { border-radius: 5px; }

  .flex--wrap { flex-wrap: wrap; }
  .flex--center { display: flex; align-items: center; justify-content: center; }
  
  /* Avatar styles */
  .avatar, .avatar-placeholder {
    width: 80px;
    height: 80px;
    object-fit: cover;
  }
  .avatar-placeholder {
    background-color: #e0e0e0;
    font-weight: bold;
  }
  
  /* Thumbnail styles */
  .stream-thumbnail, .vod-thumbnail {
    max-width: 100%;
    height: auto;
    border: 1px solid #000000;
  }
  
  /* Better contrast for e-ink */
  .label, .title, .value { color: #000000; }
  .label--gray { color: #555555; }
  .outline .label { color: #000000; }
</style>
{% endtemplate %}